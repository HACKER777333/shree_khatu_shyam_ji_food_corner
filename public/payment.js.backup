try {
    if (typeof loadCartFromFirestore === 'function') {
        paymentCart = await loadCartFromFirestore(user.email);
    } else {
        // Fallback to REST API
        const response = await fetch(`/api/cart/load?email=${encodeURIComponent(user.email)}`);
        if (!response.ok) throw new Error('Failed to load cart');
        const data = await response.json();
        paymentCart = Array.isArray(data.cart) ? data.cart : [];
    }
} catch (error) {
    console.error('[Payment Page] Error loading cart:', error);
}
}

function renderShippingSummary() {
    const summary = document.getElementById('shippingSummary');
    summary.innerHTML = `
        <p><strong>Name:</strong> ${checkoutData.customerName}</p>
        <p><strong>Email:</strong> ${checkoutData.customerEmail}</p>
        <p><strong>Phone:</strong> ${checkoutData.customerPhone}</p>
        <p><strong>Address:</strong> ${checkoutData.shippingAddress}, ${checkoutData.city}, ${checkoutData.state} - ${checkoutData.zipCode}</p>
    `;
}

function renderOrderSummary() {
    const summary = document.getElementById('paymentOrderSummary');
    if (!paymentCart.length) {
        summary.innerHTML = '<p>No items in cart.</p>';
        return;
    }

    const itemsHtml = paymentCart.map(item => `
        <div class="summary-item" style="display:flex; justify-content:space-between; padding:10px 0; border-bottom:1px solid #eee;">
            <div>
                <strong>${item.name}</strong>
                <p style="margin:4px 0 0;">Qty: ${item.quantity}</p>
            </div>
            <div>â‚¹${(item.price * item.quantity).toFixed(2)}</div>
        </div>
    `).join('');

    totalAmount = paymentCart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

    summary.innerHTML = `
        <div class="summary-items">${itemsHtml}</div>
        <div style="margin-top:20px; font-weight:700; display:flex; justify-content:space-between;">
            <span>Total Amount:</span>
            <span>â‚¹${totalAmount.toFixed(2)}</span>
        </div>
    `;
}

async function loadQRCode(amount) {
    const qrContainer = document.getElementById('qrCodeContainer');
    qrContainer.innerHTML = '<p>Loading QR Code...</p>';

    try {
        const response = await fetch(`/api/payment/qrcode?amount=${amount}`);
        const data = await response.json();
        if (data.qrCode) {
            currentUpiUrl = data.upiUrl || '';
            qrContainer.innerHTML = `
                <img src="${data.qrCode}" alt="UPI QR Code" class="qr-code-image">
                <p style="margin-top:10px;">UPI ID: <strong>${data.upiId}</strong></p>
                <button style="margin-top:10px; padding:10px 20px; border:none; border-radius:8px; background: var(--amazon-blue); color:#fff; cursor:pointer;" onclick="openPaymentApp()">Pay with UPI App</button>
            `;
        } else {
            qrContainer.innerHTML = '<p>Unable to load QR code. Please try again.</p>';
        }
    } catch (error) {
        console.error('Error loading QR code:', error);
        qrContainer.innerHTML = '<p>Unable to load QR code. Please try again.</p>';
    }
}

function openPaymentApp() {
    if (!currentUpiUrl) {
        alert('Unable to open payment app. Please scan the QR code.');
        return;
    }
    window.location.href = currentUpiUrl;
}

function confirmPayment() {
    paymentConfirmed = true;
    const confirmBtn = document.getElementById('paymentConfirmedBtn');
    const placeOrderBtn = document.getElementById('placeOrderBtn');
    confirmBtn.disabled = true;
    confirmBtn.textContent = 'Payment Confirmed âœ“';
    placeOrderBtn.disabled = false;
}

async function placeOrder() {
    if (!paymentConfirmed) {
        alert('Please confirm payment before placing the order.');
        return;
    }
    if (!paymentCart.length) {
        alert('Your cart is empty.');
        return;
    }
    if (placeOrderInProgress) {
        return;
    }

    const user = typeof getCurrentUser === 'function' ? getCurrentUser() : null;
    if (!user) {
        window.location.href = 'login.html';
        return;
    }

    const orderData = {
        customer_name: checkoutData.customerName,
        customer_email: checkoutData.customerEmail,
        customer_phone: checkoutData.customerPhone,
        shipping_address: checkoutData.shippingAddress,
        city: checkoutData.city,
        state: checkoutData.state,
        zip_code: checkoutData.zipCode,
        items: paymentCart,
        total_amount: totalAmount
    };

    const placeOrderBtn = document.getElementById('placeOrderBtn');
    if (placeOrderBtn) {
        placeOrderBtn.disabled = true;
    }
    placeOrderInProgress = true;
    showPaymentLoading('Sending your order to our team...');

    try {
        const response = await fetch('/api/orders', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(orderData)
        });

        const result = await response.json();
        if (result.success) {
            // Set flag to prevent cart empty alerts
            orderPlaced = true;

            // Clear cart from Firestore
            await clearCartOnServer(user.email);

            // Clear checkout data
            sessionStorage.removeItem(CHECKOUT_STORAGE_KEY);

            // Show success animation
            showPaymentLoading('Order placed successfully! ðŸŽ‰');
            setTimeout(() => {
                hidePaymentLoading();
                showSuccessState(result.order.order_number);
            }, 1500);
        } else {
            alert('Unable to place order. Please try again.');
            hidePaymentLoading();
            if (placeOrderBtn) {
                placeOrderBtn.disabled = false;
            }
        }
    } catch (error) {
        console.error('Error placing order:', error);
        alert('Unable to place order. Please try again.');
        hidePaymentLoading();
        if (placeOrderBtn) {
            placeOrderBtn.disabled = false;
        }
    } finally {
        placeOrderInProgress = false;
    }
}

async function clearCartOnServer(email) {
    try {
        // Use Firestore client SDK to clear cart
        if (typeof clearCartFromFirestore === 'function') {
            await clearCartFromFirestore(email);
            console.log('[Payment Page] Cart cleared from Firestore');
        } else {
            // Fallback to REST API
            await fetch('/api/cart/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, cart: [] })
            });
        }
    } catch (error) {
        console.warn('[Payment Page] Unable to clear cart on server', error);
    }
}

function showSuccessState(orderNumber) {
    // Hide payment content
    const paymentContent = document.getElementById('paymentContent');
    if (paymentContent) {
        paymentContent.style.display = 'none';
    }

    // Show success state
    const successState = document.getElementById('paymentSuccessState');
    const orderNumberEl = document.getElementById('successOrderNumber');

    if (orderNumberEl) {
        orderNumberEl.textContent = orderNumber;
    }

    if (successState) {
        successState.style.display = 'block';

        // Scroll to top to ensure success message is visible
        window.scrollTo({ top: 0, behavior: 'smooth' });

        // Prevent accidental navigation
        console.log('[Payment] Order placed successfully! Order #' + orderNumber);
    }
}

function showPaymentLoading(message) {
    const modal = document.getElementById('paymentLoadingModal');
    const statusEl = document.getElementById('paymentLoadingStatus');
    if (statusEl && message) {
        statusEl.textContent = message;
    }
    if (modal) {
        modal.classList.add('show');
    }
}

function hidePaymentLoading() {
    const modal = document.getElementById('paymentLoadingModal');
    if (modal) {
        modal.classList.remove('show');
    }
}

function setSectionPlaceholders() {
    const shippingSummary = document.getElementById('shippingSummary');
    const orderSummary = document.getElementById('paymentOrderSummary');
    const qrContainer = document.getElementById('qrCodeContainer');

    if (shippingSummary) {
        shippingSummary.innerHTML = createPlaceholderBlock(4);
    }
    if (orderSummary) {
        orderSummary.innerHTML = createPlaceholderBlock(3);
    }
    if (qrContainer) {
        qrContainer.innerHTML = `
            <div class="loading-placeholder"></div>
            <div class="loading-placeholder"></div>
            <div class="loading-placeholder" style="width:60%; margin:10px auto;"></div>
        `;
    }
}

function createPlaceholderBlock(lines = 3) {
    return Array.from({ length: lines })
        .map(() => '<div class="loading-placeholder"></div>')
        .join('');
}

